// Prisma schema for Government of Canada application framework
// Includes mandatory compliance fields for Security, Privacy, and Information Management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Connection URL is configured in prisma.config.ts
}

// =============================================================================
// ENUMS
// =============================================================================

/// Security classification levels per Government of Canada standards
enum SecurityClassification {
  UNCLASSIFIED
  PROTECTED_A
  PROTECTED_B
}

/// User roles for RBAC
enum UserRole {
  ADMIN
  MANAGER
  USER
  CITIZEN
  GUEST
}

/// Audit action types
enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS_DENIED
  EXPORT
  IMPORT
}

// =============================================================================
// MODELS
// =============================================================================

/// User model with compliance fields
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  roles         UserRole[] @default([USER])

  // Auth.js required relations
  accounts      Account[]
  sessions      Session[]

  // Compliance: Temporal tracking
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Compliance: User attribution
  createdBy     String?
  updatedBy     String?

  // Compliance: Security classification
  securityClassification SecurityClassification @default(UNCLASSIFIED)

  // Compliance: Information Management (LAC retention)
  retentionSchedule String?   // LAC retention code (e.g., "2022/001")
  dispositionDate   DateTime? // When record can be disposed

  // Compliance: Soft delete
  deletedAt     DateTime?

  // Compliance: Privacy
  isPii         Boolean   @default(true)

  // Audit trail
  auditLogs     AuditLog[]

  @@index([email])
  @@index([deletedAt])
}

/// OAuth account model (Auth.js)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Compliance: Temporal tracking
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Compliance: User attribution
  createdBy         String?
  updatedBy         String?

  // Compliance: Security classification
  securityClassification SecurityClassification @default(PROTECTED_A)

  // Compliance: Information Management
  retentionSchedule String?
  dispositionDate   DateTime?

  // Compliance: Soft delete
  deletedAt         DateTime?

  // Compliance: Privacy
  isPii             Boolean @default(true)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([deletedAt])
}

/// Session model (Auth.js)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Compliance: Temporal tracking
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Compliance: User attribution
  createdBy    String?
  updatedBy    String?

  // Compliance: Security classification
  securityClassification SecurityClassification @default(PROTECTED_A)

  // Compliance: Information Management
  retentionSchedule String?
  dispositionDate   DateTime?

  // Compliance: Soft delete
  deletedAt    DateTime?

  // Compliance: Privacy
  isPii        Boolean @default(true)

  @@index([userId])
  @@index([deletedAt])
}

/// Verification token model (Auth.js)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  // Compliance: Temporal tracking
  createdAt  DateTime @default(now())

  // Compliance: Security classification
  securityClassification SecurityClassification @default(PROTECTED_A)

  // Compliance: Privacy
  isPii      Boolean @default(false)

  @@unique([identifier, token])
}

/// Audit log model for compliance tracking
/// This table is append-only and should never be modified or deleted
model AuditLog {
  id          String      @id @default(cuid())

  // What happened
  action      AuditAction
  entityType  String      // Model name (e.g., "User", "Account")
  entityId    String      // ID of the affected record

  // Who did it
  userId      String?     // User who performed the action (null for system actions)
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  userAgent   String?     // Browser/client information
  ipAddress   String?     // Client IP address (anonymized for privacy)

  // Context
  sessionId   String?     // Session ID if available
  requestId   String?     // Correlation ID for request tracing

  // Change details
  oldValues   Json?       // Previous state (for UPDATE/DELETE)
  newValues   Json?       // New state (for CREATE/UPDATE)
  metadata    Json?       // Additional context

  // Timestamp
  timestamp   DateTime    @default(now())

  // Compliance: Security classification
  securityClassification SecurityClassification @default(UNCLASSIFIED)

  // Compliance: Information Management
  // Audit logs have specific retention requirements per TBS Directive
  retentionSchedule String @default("AUDIT-7Y") // 7 year retention for audit logs
  dispositionDate   DateTime?

  // Compliance: Privacy
  isPii       Boolean @default(false)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@index([action])
}
