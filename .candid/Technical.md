# Technical Standards - GC App Framework

> Auto-generated by candid-init on 2026-02-05
> A Government of Canada compliant Next.js framework with built-in Security, Privacy, Information Management, Accessibility, and Internationalization.

## Quick Reference

| Category | Rules | Priority Focus |
|----------|-------|----------------|
| Architecture | 12 | Layer separation, compliance extensions |
| Naming | 10 | Consistent casing, file organization |
| Security | 14 | Audit logging, input validation, headers |
| Testing | 8 | Accessibility, coverage requirements |
| React/Next.js | 12 | Server/Client separation, i18n patterns |

---

## 1. Architecture Rules

### ARCH-001: Layer Separation
**Severity:** error
**Description:** Maintain strict separation between layers: `app/` (routes), `components/` (UI), `lib/` (business logic), `i18n/` (translations).

```
✅ Good: import { prisma } from "@/lib/db/client"
❌ Bad: Database queries directly in page components
```

### ARCH-002: Prisma Extension Composition
**Severity:** error
**Description:** Always use the extended Prisma client from `lib/db/client.ts` for compliance features. Only use `prismaBase` for explicit bypass scenarios (GDPR erasure).

```typescript
// ✅ Good - Uses compliance extensions
import { prisma } from "@/lib/db/client";
await prisma.user.create({ data: userData });

// ❌ Bad - Bypasses audit logging
import { PrismaClient } from "@prisma/client";
const db = new PrismaClient();
```

### ARCH-003: Middleware Chain Order
**Severity:** error
**Description:** Middleware must execute in order: i18n routing → security headers → auth checks → RBAC. Never reorder or skip layers.

### ARCH-004: Route Group Conventions
**Severity:** warning
**Description:** Use route groups for access control: `(auth)` for public auth pages, `(protected)` for authenticated routes, `(admin)` for admin-only routes.

```
app/[locale]/(auth)/login/      # Public
app/[locale]/(protected)/       # Requires auth
app/[locale]/(admin)/           # Requires admin role
```

### ARCH-005: Provider Hierarchy
**Severity:** error
**Description:** Providers must wrap in order: `NextIntlClientProvider` → `AuthProvider` → Application components.

### ARCH-006: API Route Placement
**Severity:** warning
**Description:** API routes go in `app/api/`. Auth routes use the catch-all `[...nextauth]` pattern. Other API routes should be RESTful.

### ARCH-007: Extension Independence
**Severity:** error
**Description:** Prisma extensions (softDelete, audit, compliance) must be independent and composable. Each extension must function independently without requiring other extensions to be loaded.

### ARCH-008: Compliance Field Requirements
**Severity:** error
**Description:** All data models storing user/business data must include compliance fields: `createdAt`, `updatedAt`, `createdBy`, `updatedBy`, `deletedAt`, `securityClassification`.

### ARCH-009: Audit Logger Usage
**Severity:** warning
**Description:** Use `AuditLogger` class for explicit audit events beyond automatic Prisma logging. Required for access denied, sensitive data access, and admin actions.

### ARCH-010: No Circular Dependencies
**Severity:** error
**Description:** Prevent circular imports. The audit extension uses base client to avoid logging its own logs. Follow this pattern for similar scenarios.

### ARCH-011: Environment Configuration
**Severity:** error
**Description:** All secrets must be in environment variables, never hardcoded. Use `.env.local` for local development, never commit `.env` files.

### ARCH-012: Module Boundaries
**Severity:** error
**Description:** Each `lib/` subdirectory must export its public API from an `index.ts` file. Internal modules must not be imported directly from outside the subdirectory.

---

## 2. Naming Conventions

### NAME-001: File Naming - Components
**Severity:** error
**Description:** React components use PascalCase: `Header.tsx`, `AuthProvider.tsx`, `DefaultTemplate.tsx`.

### NAME-002: File Naming - Utilities
**Severity:** error
**Description:** Utility files and non-component modules use camelCase: `client.ts`, `rbac.ts`, `helpers.ts`.

### NAME-003: Directory Naming
**Severity:** error
**Description:** Directories use lowercase with hyphens for multi-word: `lib/`, `components/`, `next-auth/`.

### NAME-004: Route Group Naming
**Severity:** warning
**Description:** Route groups use parentheses with lowercase: `(auth)`, `(protected)`, `(admin)`.

### NAME-005: Type Naming
**Severity:** error
**Description:** Types and interfaces use PascalCase with descriptive suffixes: `UserRole`, `AuditContext`, `ComplianceContext`.

### NAME-006: Extension Naming
**Severity:** warning
**Description:** Prisma extensions use camelCase with `Extension` suffix: `softDeleteExtension`, `auditExtension`, `complianceExtension`.

### NAME-007: Test File Naming
**Severity:** error
**Description:** Test files mirror source structure with `.test.ts` or `.test.tsx` suffix: `components.test.tsx`, `helpers.test.ts`.

### NAME-008: Message Key Naming
**Severity:** warning
**Description:** i18n message keys use dot notation with namespace: `common.title`, `auth.signIn`, `dashboard.welcome`.

### NAME-009: Environment Variable Naming
**Severity:** error
**Description:** Environment variables use SCREAMING_SNAKE_CASE: `DATABASE_URL`, `AUTH_SECRET`, `AZURE_AD_CLIENT_ID`.

### NAME-010: Function Naming
**Severity:** warning
**Description:** Functions use camelCase with verb prefixes: `getComplianceContext`, `setAuditContext`, `hasPermission`.

---

## 3. Security Rules

### SEC-001: Input Validation Required
**Severity:** error
**Description:** All user inputs must be validated with Zod schemas before processing. Use strict mode with no unknown keys.

```typescript
// ✅ Good
import { z } from "zod/v4";
const schema = z.object({ email: z.email() }).strict();
const data = schema.parse(input);

// ❌ Bad - No validation
const data = req.body;
```

### SEC-002: Security Headers Required
**Severity:** error
**Description:** All responses must include security headers: CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy.

### SEC-003: CSRF Protection
**Severity:** error
**Description:** All state-changing operations must use CSRF protection. Auth.js provides this automatically for auth routes.

### SEC-004: SQL Injection Prevention
**Severity:** error
**Description:** Never use raw SQL queries. Use Prisma's parameterized queries exclusively.

### SEC-005: XSS Prevention
**Severity:** error
**Description:** Never use `dangerouslySetInnerHTML`. If absolutely required, sanitize with DOMPurify first.

### SEC-006: Soft Delete Enforcement
**Severity:** error
**Description:** Records must never be physically deleted except for GDPR Article 17 (right to erasure). Use soft delete via `deletedAt` field.

### SEC-007: Audit All Mutations
**Severity:** error
**Description:** All CREATE, UPDATE, DELETE operations must be logged to AuditLog with userId, timestamp, old/new values.

### SEC-008: PII Handling
**Severity:** error
**Description:** Fields containing PII must be marked with `isPii: true`. PII should be anonymized in audit logs using `anonymizePii()`.

### SEC-009: Session Security
**Severity:** error
**Description:** Sessions expire after 8 hours. Use JWT strategy with proper signing. Refresh tokens on activity.

### SEC-010: Role-Based Access Control
**Severity:** error
**Description:** All protected routes must check roles using `hasRole()` or `hasPermission()`. Never assume authentication implies authorization.

```typescript
// ✅ Good
if (!hasRole(session, "admin")) {
  redirect("/unauthorized");
}

// ❌ Bad - Only checks authentication
if (!session) redirect("/login");
```

### SEC-011: Secure Defaults
**Severity:** error
**Description:** Default security classification must be PROTECTED_A. Default permissions must be deny-all until explicitly granted. New models must not default to UNCLASSIFIED.

### SEC-012: No Secrets in Code
**Severity:** error
**Description:** Never commit secrets, API keys, or credentials. Use environment variables and `.env.example` for documentation.

### SEC-013: Error Message Sanitization
**Severity:** warning
**Description:** Never expose internal errors to users. Log detailed errors server-side, show generic messages client-side.

### SEC-014: Rate Limiting
**Severity:** warning
**Description:** API routes should implement rate limiting for public endpoints. Use middleware or edge functions.

---

## 4. Testing Rules

### TEST-001: Accessibility Testing Required
**Severity:** error
**Description:** All UI components must pass axe accessibility tests. Use `testA11y()` helper for consistent testing.

```typescript
import { testA11y } from "@/tests/a11y/helpers";

it("has no accessibility violations", async () => {
  const { container } = render(<MyComponent />);
  await testA11y(container);
});
```

### TEST-002: Heading Hierarchy
**Severity:** error
**Description:** Pages must have proper heading hierarchy (h1 → h2 → h3). Use `checkHeadingHierarchy()` in tests.

### TEST-003: WCAG AA Compliance
**Severity:** error
**Description:** All components must meet WCAG 2.1 AA standards:
- Focus states must be visible (minimum 2px outline or equivalent)
- Color contrast must meet 4.5:1 for normal text, 3:1 for large text
- All interactive elements must be keyboard accessible (Tab, Enter, Space, Escape)

### TEST-004: Test File Location
**Severity:** warning
**Description:** Tests go in `tests/` directory mirroring source structure. A11y tests in `tests/a11y/`, unit tests alongside source in `tests/unit/`.

### TEST-005: Mock External Dependencies
**Severity:** warning
**Description:** Mock next-intl, next/navigation, and next-auth in test setup. See `tests/setup.ts` for patterns.

### TEST-006: Coverage Requirements
**Severity:** error
**Description:** Code coverage for `lib/` must be at least 80%. Auth functions in `lib/auth/` and RBAC functions must have 100% coverage.

### TEST-007: Integration Test Patterns
**Severity:** warning
**Description:** Database tests should use test database with migrations. Clean up test data after each test.

### TEST-008: No Skipped Tests
**Severity:** warning
**Description:** Avoid `it.skip()` or `describe.skip()`. Fix or remove tests rather than skipping.

---

## 5. React/Next.js Rules

### REACT-001: Server Component Default
**Severity:** error
**Description:** Components are Server Components by default. Only add `"use client"` when using hooks, browser APIs, or event handlers.

```typescript
// ✅ Good - Server Component (default)
export default async function DashboardPage() {
  const session = await auth();
  return <Dashboard user={session?.user} />;
}

// ✅ Good - Client Component (when needed)
"use client";
export function InteractiveButton() {
  const [count, setCount] = useState(0);
  return <button onClick={() => setCount(c => c + 1)}>{count}</button>;
}
```

### REACT-002: Data Fetching in Server Components
**Severity:** error
**Description:** Fetch data in Server Components, pass to Client Components as props. Never fetch data in Client Components when Server Component can do it.

### REACT-003: Use Server Actions for Mutations
**Severity:** warning
**Description:** Use Server Actions (`"use server"`) for form submissions and mutations instead of API routes.

```typescript
// ✅ Good - Server Action
async function submitForm(formData: FormData) {
  "use server";
  await prisma.item.create({ data: { name: formData.get("name") } });
}
```

### REACT-004: i18n Translation Pattern
**Severity:** error
**Description:** Use `useTranslations()` hook in Client Components, `getTranslations()` in Server Components.

```typescript
// Server Component
const t = await getTranslations("dashboard");
return <h1>{t("title")}</h1>;

// Client Component
"use client";
const t = useTranslations("dashboard");
return <h1>{t("title")}</h1>;
```

### REACT-005: Locale in All Routes
**Severity:** error
**Description:** All app routes must be under `[locale]` dynamic segment. Use `Link` and `redirect` with locale prefix.

### REACT-006: Image Optimization
**Severity:** error
**Description:** All images must use the `next/image` component. Images must include explicit `width` and `height` props. Images in the initial viewport (above the fold) must include the `priority` prop.

> **Note:** Alt text is enforced by ESLint `jsx-a11y/alt-text` rule.

### REACT-007: No Direct DOM Manipulation
**Severity:** error
**Description:** Never use `document.querySelector` or direct DOM manipulation. Use React refs and state.

### REACT-008: Error Boundary Usage
**Severity:** error
**Description:** Features with external API calls, file uploads, or user-generated content rendering must be wrapped in error boundaries. Use `error.tsx` files for route-level error handling.

### REACT-009: Loading States
**Severity:** warning
**Description:** Use `loading.tsx` for route-level loading. Use Suspense boundaries for component-level loading.

### REACT-010: Metadata Export
**Severity:** warning
**Description:** Pages should export `metadata` or `generateMetadata` for SEO. Include title, description, and Open Graph data.

### REACT-011: Link Component Usage
**Severity:** error
**Description:** Use `next/link` for all internal navigation. Never use `<a href>` for internal links.

> **Note:** Also enforced by ESLint `@next/next/no-html-link-for-pages` rule.

### REACT-012: Form Accessibility
**Severity:** error
**Description:** All form inputs must have associated labels. Use `htmlFor` attribute or wrap input in label element.

> **Note:** Also enforced by ESLint `jsx-a11y/label-has-associated-control` rule.

---

## 6. GC Design System Rules

### GCDS-001: Use Official Components
**Severity:** error
**Description:** Use GCDS components (`@cdssnc/gcds-components-react-ssr`) for: buttons, forms, headers, footers, navigation, and alerts. Custom components are only permitted when GCDS lacks equivalent functionality.

### GCDS-002: Bilingual Content
**Severity:** error
**Description:** All user-facing content must be available in both English and French. Use i18n messages, never hardcode text.

### GCDS-003: Canada.ca Branding
**Severity:** error
**Description:** Header must include Government of Canada signature and language toggle. Footer must include required GC links.

### GCDS-004: FIP Compliance
**Severity:** warning
**Description:** Follow Federal Identity Program guidelines for logos, colors, and typography.

---

## Appendix: File Patterns

### Files Requiring Security Review
- `middleware.ts` - Auth and security header configuration
- `lib/auth/**` - Authentication and authorization logic
- `lib/db/extensions/**` - Database security extensions
- `app/api/**` - API endpoints

### Files Requiring A11y Review
- `components/**/*.tsx` - All React components
- `app/[locale]/**/page.tsx` - All page components

### Files Requiring i18n Review
- `app/[locale]/**` - All locale-based routes
- `i18n/messages/**` - Translation files (must have en.json and fr.json)

---

## Changelog

| Date | Version | Changes |
|------|---------|---------|
| 2026-02-05 | 1.1.0 | Validation fixes: strengthened vague rules, added thresholds, noted linter overlaps |
| 2026-02-05 | 1.0.0 | Initial generation from codebase analysis |
